version: 1.0
description: renew letsencrypt
input: 
  - server_ip

tasks:
  open_port:
    action: nufuk.open_port
    input:
      in_port: "80"
      out_port: "80"
      server_ip: <% ctx(server_ip) %>
    next:
      - when: <% succeeded() %>
        do: 
          - renew_letsencrypt
      - when: <% failed() %>
        do: 
          - send_failed

  renew_letsencrypt:
    action: core.remote_sudo
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "certbot renew"
      username: "nufuk"
    next:
      - when: <% 'command not found' in result().values().first().stdout %>
        do: 
          - close_port
          - send_no_certificate
      - when: <% 'Certificate not yet due for renewal' in result().values().first().stdout %>
        do: 
          - close_port
          - send_not_due
      - when: <% 'renew failure' in result().values().first().stdout %>
        do: 
          - close_port
          - send_failed
      - when: <% 'Congratulations, all renewals succeeded' in result().values().first().stdout %>
        do: 
          - close_port
          - send_success

  close_port:
    action: nufuk.close_port
    input:
      in_port: "80"
      out_port: "80"
      server_ip: <% ctx(server_ip) %>
    next:
      - when: <% succeeded() %>
        do: 
          - send_success
      - when: <% failed() %>
        do: 
          - send_failed

  send_failed:
    action: nufuk.telegram_message
    input:
      message: "Renewing letsencrypt certificate failed. Please check: <% ctx(server_ip) %>"
  
  send_success:
    action: nufuk.telegram_message
    input:
      message: "Renewing letsencrypt certificate succeeded: <% ctx(server_ip) %>"

  send_no_certificate:
    action: nufuk.telegram_message
    input:
      message: "Server has no SSL certificates: <% ctx(server_ip) %>"

  send_not_due:
    action: nufuk.telegram_message
    input:
      message: "Certificate not yet due for renewal: <% ctx(server_ip) %>"