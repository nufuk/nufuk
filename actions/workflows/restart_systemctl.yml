version: 1.0
description: restart services
input: 
  - hosts
  - username
  - service
  - grafana_data
tasks:
  print_out_payload:
    action: core.echo
    input:
      message: <% ctx().grafana_data %>
    next:
      - do: next_print
        publish:
          - json_data: {{ ctx().grafana_data | tojson }}

  next_print:
  action: core.echo
  input:
    message: {{ ctx().get('json_data') }}
  next:
      - do: restart_service

  restart_service:
    action: core.remote_sudo
    input:
      #cmd: "systemctl restart  <% ctx().grafana_data.alerts.get(0).labels.process_name.replace('_', '') %>"
      #hosts: <% ctx().grafana_data.to_json_common().alerts[0].labels.instance.split(':')[0] %>
      hosts: <% ctx(json_data).alerts[0].labels.instance %>
      cmd: "systemctl restart  <% ctx(json_data).alerts[0].labels.process_name %>"
      username: <% ctx(username) %>
