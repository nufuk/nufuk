version: 1.0
description: restart services
input: 
  - hosts
  - username
  - service
  - grafana_data
tasks:
  print_out_payload:
    action: core.echo
    input:
      message: <% ctx(grafana_data) %>
    next:
      #- do: restart_service
      - do: next_print
        publish:
          - json_data: <% ctx().grafana_data.replace('\'', '"') %>

  next_print:
    action: core.echo
    input:
      message: <% ctx(json_data) %>
    next:
      - do: restart_service
        publish:
          - json_stuff: "{{ ctx().json_data | from_json_string }}"

  restart_service:
    action: core.remote_sudo
    input:
      #cmd: "systemctl restart  <% ctx().grafana_data.alerts.get(0).labels.process_name.replace('_', '') %>"
      hosts: <% ctx().json_stuff.alerts %>
      #hosts: {{ ctx().grafana_data | string }}
      cmd: "systemctl restart  <% ctx(json_stuff).alerts[0].labels.process_name %>"
      username: <% ctx(username) %>
