version: 1.0
description: restart services
input: 
  - username 
  - password
  - in_port
  - out_port
  - server_ip
  - description
tasks:
  checkout_project:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "git clone https://github.com/nufuk/fritz_port_manager.git"
      cwd: "/tmp/"
      username: "nufuk"
    next:
      - do: install_dependencies
        when: <% succeeded() %>
      - do: cleanup
        when: <? failed() ?>

  install_dependencies:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "./install.sh"
      cwd: "/tmp/fritz_port_manager"
      username: "nufuk"
    next:
      - do: open_port
        when: <% succeeded() %>
      - do: cleanup
        when: <? failed() ?>

  open_port:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "./main.py -m open -u <? ctx(username) ?> -p <? ctx(password) ?> -i <? ctx(in_port) ?> -o <? ctx(out_port) ?> -s <? ctx(server_ip) ?> -d <? ctx(description) ?>"
      cwd: "/tmp/fritz_port_manager"
      username: "nufuk"
    next:
        do: cleanup

  cleanup:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "rm -rf ./fritz_port_manager"
      cwd: "/tmp/"
      username: "nufuk"
