version: 1.0
description: open port
input: 
  - username 
  - password
  - in_port
  - out_port
  - server_ip
  - description
tasks:
  checkout_project:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "git clone https://github.com/nufuk/fritz_port_manager.git"
      cwd: "/tmp/"
      username: "nufuk"
    next:
      - when: <% succeeded() %>
        do: 
          - install_dependencies
      - when: <% failed() %>
        do: 
          - cleanup
          - send_failed

  install_dependencies:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "./install.sh"
      cwd: "/tmp/fritz_port_manager"
      username: "nufuk"
    next:
      - when: <% succeeded() %>
        do: 
          - open_port
      - when: <% failed() %>
        do: 
          - cleanup
          - send_failed

  open_port:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "./main.py -m open -u <% ctx(username) %> -p <% ctx(password) %> -i <% ctx(in_port) %> -o <% ctx(out_port) %> -s <% ctx(server_ip) %> -d '<% ctx(description) %>'"
      cwd: "/tmp/fritz_port_manager"
      username: "nufuk"
    next:
        - when: <% succeeded() %>
          do:
            - cleanup
            - send_success
        - when: <% failed() %>
          do: 
            - cleanup
            - send_failed
  cleanup:
    action: core.remote
    input:
      hosts: <% ctx(server_ip) %>
      cmd: "rm -rf ./fritz_port_manager"
      cwd: "/tmp/"
      username: "nufuk"

  send_failed:
    action: nufuk.telegram_message
    input:
      message: "opening port failed. Please check: <% ctx(in_port) %> <% ctx(server_ip) %>"
  
  send_success:
    action: nufuk.telegram_message
    input:
      message: "opening port succeeded: <% ctx(in_port) %> <% ctx(server_ip) %>"